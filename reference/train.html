<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Train a fusion model — train • fusionModel</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Train a fusion model — train"><meta name="description" content='Train a fusion model on "donor" data using sequential LightGBM models to model the conditional distributions. The resulting fusion model (.fsn file) can be used with fuse to simulate outcomes for a "recipient" dataset.'><meta property="og:description" content='Train a fusion model on "donor" data using sequential LightGBM models to model the conditional distributions. The resulting fusion model (.fsn file) can be used with fuse to simulate outcomes for a "recipient" dataset.'></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fusionModel</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.3.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Train a fusion model</h1>

      <div class="d-none name"><code>train.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Train a fusion model on "donor" data using sequential <a href="https://lightgbm.readthedocs.io/en/latest/" class="external-link">LightGBM</a> models to model the conditional distributions. The resulting fusion model (.fsn file) can be used with <code><a href="fuse.html">fuse</a></code> to simulate outcomes for a "recipient" dataset.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">train</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  <span class="va">y</span>,</span>
<span>  <span class="va">x</span>,</span>
<span>  fsn <span class="op">=</span> <span class="st">"fusion_model.fsn"</span>,</span>
<span>  weight <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  nfolds <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  nquantiles <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  nclusters <span class="op">=</span> <span class="fl">2000</span>,</span>
<span>  krange <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">500</span><span class="op">)</span>,</span>
<span>  hyper <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  fork <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>Data frame. Donor dataset. Categorical variables must be factors and ordered whenever possible.</p></dd>


<dt id="arg-y">y<a class="anchor" aria-label="anchor" href="#arg-y"></a></dt>
<dd><p>Character or list. Variables in <code>data</code> to eventually fuse to a recipient dataset. Variables are fused in the order provided. If <code>y</code> is a list, each entry is a character vector possibly indicating multiple variables to fuse as a block.</p></dd>


<dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>Character or list. Predictor variables in <code>data</code> common to donor and eventual recipient. If a list, each slot specifies the <code>x</code> predictors to use for each <code>y</code>.</p></dd>


<dt id="arg-fsn">fsn<a class="anchor" aria-label="anchor" href="#arg-fsn"></a></dt>
<dd><p>Character. File path where fusion model will be saved. Must use <code>.fsn</code> suffix.</p></dd>


<dt id="arg-weight">weight<a class="anchor" aria-label="anchor" href="#arg-weight"></a></dt>
<dd><p>Character. Name of the observation weights column in <code>data</code>. If NULL (default), uniform weights are assumed.</p></dd>


<dt id="arg-nfolds">nfolds<a class="anchor" aria-label="anchor" href="#arg-nfolds"></a></dt>
<dd><p>Numeric. Number of cross-validation folds used for LightGBM model training. Or, if <code>nfolds &lt; 1</code>, the fraction of observations to use for training set; remainder used for validation (faster than cross-validation).</p></dd>


<dt id="arg-nquantiles">nquantiles<a class="anchor" aria-label="anchor" href="#arg-nquantiles"></a></dt>
<dd><p>Numeric. Number of quantile models to train for continuous <code>y</code> variables, in addition to the conditional mean. <code>nquantiles</code> evenly-distributed percentiles are used. For example, the default <code>nquantiles = 2</code> yields quantile models for the 25th and 75th percentiles. Higher values may produce more accurate conditional distributions at the expense of computation time. Even <code>nquantiles</code> is recommended since the conditional mean tends to capture the central tendency, making a median model superfluous.</p></dd>


<dt id="arg-nclusters">nclusters<a class="anchor" aria-label="anchor" href="#arg-nclusters"></a></dt>
<dd><p>Numeric. Maximum number of k-means clusters to use. Higher is better but at computational cost. <code>nclusters = 0</code> or <code>nclusters = Inf</code> turn off clustering.</p></dd>


<dt id="arg-krange">krange<a class="anchor" aria-label="anchor" href="#arg-krange"></a></dt>
<dd><p>Numeric. Minimum and maximum number of nearest neighbors to use for construction of continuous conditional distributions. Higher <code>max(krange)</code> is better but at computational cost.</p></dd>


<dt id="arg-hyper">hyper<a class="anchor" aria-label="anchor" href="#arg-hyper"></a></dt>
<dd><p>List. LightGBM hyperparameters to be used during model training. If <code>NULL</code>, default values are used. See Details and Examples.</p></dd>


<dt id="arg-fork">fork<a class="anchor" aria-label="anchor" href="#arg-fork"></a></dt>
<dd><p>Logical. Should parallel processing via forking be used, if possible? See Details.</p></dd>


<dt id="arg-cores">cores<a class="anchor" aria-label="anchor" href="#arg-cores"></a></dt>
<dd><p>Integer. Number of physical CPU cores used for parallel computation. When <code>fork = FALSE</code> or on Windows platform (since forking is not possible), the fusion variables/blocks are processed serially but LightGBM uses <code>cores</code> for internal multithreading via OpenMP. On a Unix system, if <code>fork = TRUE</code>, <code>cores &gt; 1</code>, and <code>cores &lt;= length(y)</code> then the fusion variables/blocks are processed in parallel via <code><a href="https://rdrr.io/r/parallel/mclapply.html" class="external-link">mclapply</a></code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A fusion model object (.fsn) is saved to <code>fsn</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>When <code>y</code> is a list, each slot indicates either a single variable or, alternatively, multiple variables to fuse as a block. Variables within a block are sampled jointly from the original donor data during fusion. See Examples.</p>
<p><code>y</code> variables that exhibit no variance or continuous <code>y</code> variables with less than <code>10 * nfolds</code> non-zero observations (minimum required for cross-validation) are automatically removed with a warning.</p>
<p>The fusion model written to <code>fsn</code> is a zipped archive created by <code><a href="https://r-lib.github.io/zip/reference/zip.html" class="external-link">zip</a></code> containing models and data required by <code><a href="fuse.html">fuse</a></code>.</p>
<p>The <code>hyper</code> argument can be used to specify the LightGBM hyperparameter values over which to perform a "grid search" during model training. <a href="https://lightgbm.readthedocs.io/en/latest/Parameters.html" class="external-link">See here</a> for the full list of parameters. For each combination of hyperparameters, <code>nfolds</code> cross-validation is performed using <code><a href="https://rdrr.io/pkg/lightgbm/man/lgb.cv.html" class="external-link">lgb.cv</a></code> with an early stopping condition. The parameter combination with the lowest loss function value is used to fit the final model via <code><a href="https://rdrr.io/pkg/lightgbm/man/lgb.train.html" class="external-link">lgb.train</a></code>. The more candidate parameter values specified in <code>hyper</code>, the longer the processing time. If <code>hyper = NULL</code>, a single set of parameters is used with the following default values:</p>
<ul><li><p>boosting = "gbdt"</p></li>
<li><p>data_sample_strategy = "goss"</p></li>
<li><p>num_leaves = 31</p></li>
<li><p>feature_fraction = 0.8</p></li>
<li><p>max_depth = 5</p></li>
<li><p>min_data_in_leaf = max(10, round(0.001 * nrow(data)))</p></li>
<li><p>num_iterations = 2500</p></li>
<li><p>learning_rate= 0.1</p></li>
<li><p>max_bin = 255</p></li>
<li><p>min_data_in_bin = 3</p></li>
<li><p>max_cat_threshold = 32</p></li>
</ul><p>Typical users will only have reason to modify the hyperparameters listed above. Note that <code>num_iterations</code> only imposes a ceiling, since early stopping will typically result in models with a lower number of iterations. See Examples.</p>
<p>Testing with small-to-medium size datasets suggests that forking is typically faster than OpenMP multithreading (the default). However, forking will sometimes "hang" (continue to run with no CPU usage or error message) if an OpenMP process has been previously used in the same session. The issue appears to be related to Intel's OpenMP implementation (<a href="https://github.com/Rdatatable/data.table/issues/2418" class="external-link">see here</a>). This can be triggered when other operations are called before <code>train()</code> that use <code><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></code> or <code><a href="http://www.fstpackage.org/reference/fst.html" class="external-link">fst</a></code> in multithread mode. If you experience hanged forking, try calling <code>data.table::setDTthreads(1)</code> and <code>fst::threads_fst(1)</code> immediately after <code><a href="https://ummel.github.io/fusionModel/">library(fusionModel)</a></code> in a new session.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="co"># Build a fusion model using RECS microdata</span></span>
<span><span class="co"># Note that "fusion_model.fsn" will be written to working directory</span></span>
<span><span class="op">?</span><span class="va">recs</span></span>
<span><span class="va">fusion.vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"electricity"</span>, <span class="st">"natural_gas"</span>, <span class="st">"aircon"</span><span class="op">)</span></span>
<span><span class="va">predictor.vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">recs</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span></span>
<span><span class="va">fsn.path</span> <span class="op">&lt;-</span> <span class="fu">train</span><span class="op">(</span>data <span class="op">=</span> <span class="va">recs</span>, y <span class="op">=</span> <span class="va">fusion.vars</span>, x <span class="op">=</span> <span class="va">predictor.vars</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># When 'y' is a list, it can specify variables to fuse as a block</span></span>
<span><span class="va">fusion.vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"electricity"</span>, <span class="st">"natural_gas"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"heating_share"</span>, <span class="st">"cooling_share"</span>, <span class="st">"other_share"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fusion.vars</span></span>
<span><span class="fu">train</span><span class="op">(</span>data <span class="op">=</span> <span class="va">recs</span>, y <span class="op">=</span> <span class="va">fusion.vars</span>, x <span class="op">=</span> <span class="va">predictor.vars</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># When 'x' is a list, it specifies which predictor variables to use for each 'y'</span></span>
<span><span class="va">xlist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">predictor.vars</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="va">predictor.vars</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span>, <span class="va">predictor.vars</span><span class="op">)</span></span>
<span><span class="va">xlist</span></span>
<span><span class="fu">train</span><span class="op">(</span>data <span class="op">=</span> <span class="va">recs</span>, y <span class="op">=</span> <span class="va">fusion.vars</span>, x <span class="op">=</span> <span class="va">xlist</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify a single set of LightGBM hyperparameters</span></span>
<span><span class="co"># Here we use Random Forests instead of the default Gradient Boosting Decision Trees</span></span>
<span><span class="fu">train</span><span class="op">(</span>data <span class="op">=</span> <span class="va">recs</span>, y <span class="op">=</span> <span class="va">fusion.vars</span>, x <span class="op">=</span> <span class="va">predictor.vars</span>,</span>
<span>      hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>boosting <span class="op">=</span> <span class="st">"rf"</span>,</span>
<span>                   feature_fraction <span class="op">=</span> <span class="fl">0.6</span>,</span>
<span>                   max_depth <span class="op">=</span> <span class="fl">10</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify a range of LightGBM hyperparameters to search over</span></span>
<span><span class="co"># This takes longer, because there are more models to test</span></span>
<span><span class="fu">train</span><span class="op">(</span>data <span class="op">=</span> <span class="va">recs</span>, y <span class="op">=</span> <span class="va">fusion.vars</span>, x <span class="op">=</span> <span class="va">predictor.vars</span>,</span>
<span>      hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>max_depth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>                   feature_fraction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.7</span>, <span class="fl">0.9</span><span class="op">)</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span></code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kevin Ummel.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

