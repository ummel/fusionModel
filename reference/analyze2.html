<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Calculation of point estimates and associated margin of error for analyses using fused/synthetic microdata with replicate weights. Efficiently computes means, proportions, sums, counts, medians, standard deviations, and variances, optionally across population subgroups.
This differs from analyze in that it requires replicate weights and calculates uncertainty using full replicate weight variance (no approximation)."><title>Analyze fusion output — analyze2 • fusionModel</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Analyze fusion output — analyze2"><meta property="og:description" content="Calculation of point estimates and associated margin of error for analyses using fused/synthetic microdata with replicate weights. Efficiently computes means, proportions, sums, counts, medians, standard deviations, and variances, optionally across population subgroups.
This differs from analyze in that it requires replicate weights and calculates uncertainty using full replicate weight variance (no approximation)."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">fusionModel</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.2.7</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"></ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Analyze fusion output</h1>
      
      <div class="d-none name"><code>analyze2.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Calculation of point estimates and associated margin of error for analyses using fused/synthetic microdata with replicate weights. Efficiently computes means, proportions, sums, counts, medians, standard deviations, and variances, optionally across population subgroups.
This differs from <a href="analyze.html">analyze</a> in that it requires replicate weights and calculates uncertainty using full replicate weight variance (no approximation).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">analyze2</span><span class="op">(</span></span>
<span>  <span class="va">analyses</span>,</span>
<span>  <span class="va">implicates</span>,</span>
<span>  <span class="va">static</span>,</span>
<span>  <span class="va">weight</span>,</span>
<span>  <span class="va">rep_weights</span>,</span>
<span>  by <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  var_scale <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  cores <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>analyses</dt>
<dd><p>List. Specifies the desired analyses. See Details and Examples. Variables referenced in <code>analyses</code> must be in <code>implicates</code> or <code>static</code>.</p></dd>


<dt>implicates</dt>
<dd><p>Data frame or file path. Implicates of synthetic (fused) variables; typically the output from <a href="fuse.html">fuse</a>. The implicates should be row-stacked and identified by integer column "M". If a file path to a ".fst" file, only the necessary columns are read into memory.</p></dd>


<dt>static</dt>
<dd><p>Data frame or file path. Static variables that do not vary across implicates; typically the "recipient" microdata passed to <a href="fuse.html">fuse</a>. At a minimum, <code>static</code> must contain <code>weight</code> and <code>rep_weights</code>. If a file path to a ".fst" file, only the necessary columns are read into memory. Note that <code>nrow(static) = nrow(implicates) / max(implicates$M)</code> and the row-ordering is assumed to be consistent between <code>static</code> and <code>implicates</code>.</p></dd>


<dt>weight</dt>
<dd><p>Character. Name of the primary observation weights column in <code>static</code>.</p></dd>


<dt>rep_weights</dt>
<dd><p>Character. Vector of replicate weight columns in <code>static</code>.</p></dd>


<dt>by</dt>
<dd><p>Character. Optional column name(s) in <code>implicates</code> or <code>static</code> (typically factors) that collectively define the set of population subgroups for which each analysis is executed. If <code>NULL</code>, analysis is done for the whole sample.</p></dd>


<dt>var_scale</dt>
<dd><p>Scalar. Factor by which to scale the unadjusted replicate weight variance. This is determined by the survey design. The default (<code>var_scale = 4</code>) is appropriate for ACS and RECS.</p></dd>


<dt>cores</dt>
<dd><p>Integer. Number of cores used for multithreading in <code><a href="https://sebkrantz.github.io/collapse/reference/collapse-package.html" class="external-link">collapse-package</a></code> functions.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A tibble reporting analysis results, possibly across subgroups defined in <code>by</code>. The returned quantities include:</p>


<dl><dt>lhs</dt>
<dd><p>Optional analysis name; the "left hand side" of the analysis formula.</p></dd>

<dt>rhs</dt>
<dd><p>The "right hand side" of the analysis formula.</p></dd>

<dt>type</dt>
<dd><p>Type of analysis: sum, mean, median, prop(ortion) or count.</p></dd>

<dt>level</dt>
<dd><p>Factor levels for categorical analyses; NA or omitted otherwise.</p></dd>

<dt>est</dt>
<dd><p>Point estimate; mean estimate across implicates.</p></dd>

<dt>moe</dt>
<dd><p>Margin of error associated with the 90% confidence interval.</p></dd>

<dt>rshare</dt>
<dd><p>Share of MOE attributable to replicate weights (as opposed to variance across implicates).</p></dd>


</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The final point estimates are the mean estimates across implicates. The final margin of error is derived from the pooled standard error across implicates, calculated using Rubin's pooling rules (1987). The within-implicate standard error's are calculated using the replicate weights and <code>var_scale</code>.</p>
<p>Each entry in the <code>analyses</code> list is a <code><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></code> of the format <code>Z ~ F(E)</code>, where <code>Z</code> is an optional, user-friendly name for the analysis, <code>F</code> is an allowable “outer function”, and <code>E</code> is an “inner expression” containing one or more microdata variables. For example:</p>
<p><code>mysum ~ mean(Var1 + Var2)</code></p>
<p>In this case, the outer function is mean(). Allowable outer functions are: mean(), sum(), median(), sd(), and var(). When the inner expression contains more than one variable, it is first evaluated and then <code><a href="https://rdrr.io/r/base/logical.html" class="external-link">F()</a></code> is applied to the result. In this case, an internal variable <code>X = Var1 + Var2</code> is generated across all observations, and then <code>mean(X)</code> is computed.</p>
<p>If no inner expression is desired, the <code>analyses</code> list can use the following convenient syntax to apply a single outer function to multiple variables:</p>
<p><code>mean = c("Var1", "Var2")</code></p>
<p>The inner expression can also utilize any function that takes variable names as arguments and returns a vector with the same length as the inputs. This is useful for defining complex operations in a separate function (e.g. microsimulation). For example:</p>
<p><code>myfun = function(Var1, Var2) {Var1 + Var2}</code></p>
<p><code>mysum ~ mean(myfun(Var1, Var2))</code></p>
<p>The use of sum() or mean() with an inner expression that returns a categorical vector automatically results in category-wise weighted counts and proportions, respectively. For example, the following analysis would fail if evaluated literally, since mean() expects numeric input but the inner expression returns character. But this is interpreted as a request to return weighted proportions for each categorical outcome.</p>
<p><code>myprop ~ mean(ifelse(Var1 &gt; 10 , 'Yes', 'No'))</code></p>
<p><code>analyze2()</code> uses "fast" versions of the allowable outer functions, as provided by <code><a href="https://sebkrantz.github.io/collapse/reference/fast-statistical-functions.html" class="external-link">fast-statistical-functions</a></code> in the <code>collapse</code> package. These functions are highly optimized for weighted, grouped calculations. In addition, outer functions mean(), sum(), and median() enjoy the use of platform-independent multithreading across columns when <code>cores &gt; 1</code>. Analyses with numerical inner expressions are processed using a series of calls to <code><a href="https://sebkrantz.github.io/collapse/reference/collap.html" class="external-link">collap</a></code> with unique observation weights. Analyses with categorical inner expressions utilize a series of calls to <code><a href="https://sebkrantz.github.io/collapse/reference/fsum.html" class="external-link">fsum</a></code>.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Rubin, D.B. (1987). <em>Multiple imputation for nonresponse in surveys</em>. Hoboken, NJ: Wiley.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="co"># Build a fusion model using RECS microdata</span></span>
<span><span class="va">fusion.vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"electricity"</span>, <span class="st">"natural_gas"</span>, <span class="st">"aircon"</span>, <span class="st">"insulation"</span><span class="op">)</span></span>
<span><span class="va">predictor.vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">recs</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span></span>
<span><span class="va">fsn.path</span> <span class="op">&lt;-</span> <span class="fu"><a href="train.html">train</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">recs</span>, y <span class="op">=</span> <span class="va">fusion.vars</span>, x <span class="op">=</span> <span class="va">predictor.vars</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate 30 implicates of the 'fusion.vars' using original RECS as the recipient</span></span>
<span><span class="va">recipient</span> <span class="op">&lt;-</span> <span class="va">recs</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">predictor.vars</span>, <span class="st">"weight"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"rep_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">96</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="fuse.html">fuse</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">recipient</span>, fsn <span class="op">=</span> <span class="va">fsn.path</span>, M <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#-----</span></span>
<span></span>
<span><span class="co"># Example of custom pre-processing function</span></span>
<span><span class="va">myfun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">v1</span>, <span class="va">v2</span>, <span class="va">v3</span><span class="op">)</span> <span class="va">v1</span> <span class="op">+</span> <span class="va">v2</span> <span class="op">+</span> <span class="va">v3</span></span>
<span></span>
<span><span class="co"># Various ways to specify analyses...</span></span>
<span><span class="va">my.analyses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="co"># Return means for 'electricity' and proportions for 'aircon'</span></span>
<span>  mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"electricity"</span>, <span class="st">"aircon"</span><span class="op">)</span>,</span>
<span>  <span class="co"># Identical to mean = "electricity"; duplicate analyses automatically removed</span></span>
<span>  <span class="va">electricity</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">electricity</span><span class="op">)</span>,</span>
<span>  <span class="co"># Simple addition in the inner expression</span></span>
<span>  <span class="va">mysum</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">electricity</span> <span class="op">+</span> <span class="va">natural_gas</span><span class="op">)</span>,</span>
<span>  <span class="co"># Standard deviation of electricity</span></span>
<span>  sd <span class="op">=</span> <span class="st">"electricity"</span>,</span>
<span>  <span class="co"># Unnamed analyses (no left-hand side in formula)</span></span>
<span>  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">electricity</span> <span class="op">+</span> <span class="va">natural_gas</span><span class="op">)</span>,</span>
<span>  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">insulation</span><span class="op">)</span>,  <span class="co"># Proportions</span></span>
<span>  <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">insulation</span><span class="op">)</span>,  <span class="co"># Counts</span></span>
<span>  <span class="co"># Proportions involving manipulation of &gt;1 variable</span></span>
<span>  <span class="va">myprop</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">aircon</span> <span class="op">!=</span> <span class="st">"No air conditioning"</span> <span class="op">&amp;</span> <span class="va">insulation</span> <span class="op">&lt;</span> <span class="st">"Adequately insulated"</span><span class="op">)</span>,</span>
<span>  <span class="co"># Custom inner function</span></span>
<span>  <span class="va">mycustom</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="fu">myfun</span><span class="op">(</span><span class="va">electricity</span>, <span class="va">natural_gas</span>, v3 <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Do the requeted analyses, by "division"</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">analyze2</span><span class="op">(</span></span>
<span> analyses <span class="op">=</span> <span class="va">my.analyses</span>,</span>
<span> implicates <span class="op">=</span> <span class="va">sim</span>,</span>
<span> static <span class="op">=</span> <span class="va">recipient</span>,</span>
<span> weight <span class="op">=</span> <span class="st">"weight"</span>,</span>
<span> rep_weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"rep_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">96</span><span class="op">)</span>,</span>
<span> by <span class="op">=</span> <span class="st">"division"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#-----</span></span>
<span></span>
<span><span class="co"># To calculate a conditional estimate, set unused/ignored observations to NA</span></span>
<span><span class="co"># All outer functions execute with 'na.rm = TRUE'</span></span>
<span><span class="co"># Example: mean natural_gas conditional on natural_gas &gt; 0</span></span>
<span><span class="co"># data.table::fifelse() is much faster than base::ifelse() for large data</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">analyze2</span><span class="op">(</span></span>
<span> analyses <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/fifelse.html" class="external-link">fifelse</a></span><span class="op">(</span><span class="va">natural_gas</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">natural_gas</span>, <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span>,</span>
<span> implicates <span class="op">=</span> <span class="va">sim</span>,</span>
<span> static <span class="op">=</span> <span class="va">recipient</span>,</span>
<span> weight <span class="op">=</span> <span class="st">"weight"</span>,</span>
<span> rep_weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"rep_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">96</span><span class="op">)</span>,</span>
<span> by <span class="op">=</span> <span class="st">"division"</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Kevin Ummel.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

